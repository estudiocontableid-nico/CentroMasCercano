<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RENAXOC - Centro mas Cercano</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <!-- Lógica de la aplicación embebida para funcionar sin servidor (file://) -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        const ADMIN_USER = "nicodemarax";
        const LOGO_URL = "https://drive.google.com/thumbnail?id=1Vo0oD18nSTo_uFxrsELW6kTffF0zHQXx&sz=w200";

        // Coordenadas aproximadas de las ciudades (Fallback para filtrado inicial)
        const CITY_COORDINATES = {
            "san francisco": { lat: -31.427, lon: -62.082 },
            "morteros": { lat: -30.711, lon: -62.003 },
            "rafaela": { lat: -31.250, lon: -61.486 },
            "rosario": { lat: -32.944, lon: -60.639 },
            "santa fe": { lat: -31.633, lon: -60.700 },
            "rufino": { lat: -34.268, lon: -62.712 },
            "galvez": { lat: -32.028, lon: -61.221 },
            "ceres": { lat: -29.883, lon: -61.947 },
            "cañada de gomez": { lat: -32.816, lon: -61.395 },
            "villa constitucion": { lat: -33.227, lon: -60.329 },
            "san lorenzo": { lat: -32.748, lon: -60.733 },
            "parana": { lat: -31.731, lon: -60.518 },
            "san jorge": { lat: -31.896, lon: -61.859 },
            "villa ocampo": { lat: -28.489, lon: -59.358 },
            "villa gobernador galvez": { lat: -33.024, lon: -60.632 },
            "casilda": { lat: -33.044, lon: -61.168 },
            "venado tuerto": { lat: -33.745, lon: -61.968 },
            "san justo": { lat: -30.789, lon: -60.592 },
            "reconquista": { lat: -29.150, lon: -59.650 }
        };

        const EMBEDDED_CENTERS = [
          {"name": "CEPAR SRL (San Francisco)","address": "Dante Alighieri 1257","city": "San Francisco","province": "Cordoba"},
          {"name": "CEPAR SRL (Morteros)","address": "Blvd. Illia 48","city": "Morteros","province": "Cordoba"},
          {"name": "CER Rafaela SRL","address": "Necochea 260","city": "Rafaela","province": "Santa Fe"},
          {"name": "Sanatorio Delta (Dr Eduardo M Olazarri)","address": "Mendoza 1560","city": "Rosario","province": "Santa Fe"},
          {"name": "Servicio Privado de Dialisis Riccobelli SRL","address": "San Jerónimo 3178","city": "Santa Fe","province": "Santa Fe"},
          {"name": "Unidad Medica Renal Rufino SRL","address": "Alem Vieyra 1261","city": "Rufino","province": "Santa Fe"},
          {"name": "Centro de Terapia Renal SRL","address": "25 de Mayo 25","city": "Rafaela","province": "Santa Fe"},
          {"name": "Dra Maria Angelica Giudice","address": "Sarmiento 303","city": "Galvez","province": "Santa Fe"},
          {"name": "Nefrored SA Sanatorio Británico","address": "Paraguay 40","city": "Rosario","province": "Santa Fe"},
          {"name": "CEPAC SA","address": "Hernandarias 46","city": "Ceres","province": "Santa Fe"},
          {"name": "Centro de Hemodialisis Cañada de Gómez","address": "Almte. Brown 832","city": "Cañada De Gomez","province": "Santa Fe"},
          {"name": "Centro Medico Rivadavia SRL","address": "Córdoba 318","city": "Villa Constitucion","province": "Santa Fe"},
          {"name": "Instituto Integral de Nefrologia SA","address": "Dr. Ghio 474","city": "San Lorenzo","province": "Santa Fe"},
          {"name": "INER Siglo Siglo XXI SA (La Paz)","address": "Santiago del Estero 511","city": "Parana","province": "Entre Rios"},
          {"name": "FANEF SRL","address": "CPN Nelsis Muriziasco 1556","city": "San Jorge","province": "Santa Fe"},
          {"name": "Centro Integral de Dialisis SRL","address": "La Paz 1045","city": "Rosario","province": "Santa Fe"},
          {"name": "Nefrosur Terapias Renales","address": "Arijón 145","city": "Rosario","province": "Santa Fe"},
          {"name": "Nefro Red SA Sanatorio Norte","address": "Blvd. Rondeau 1365","city": "Rosario","province": "Santa Fe"},
          {"name": "NEFAR SRL","address": "San Juan 3034","city": "Rosario","province": "Santa Fe"},
          {"name": "Servicio de Nefrologia Clinica Ocampo","address": "Blvr. Urquiza 1551","city": "Villa Ocampo","province": "Santa Fe"},
          {"name": "SINEF Servicios de Nefrologia","address": "Pres. Roca 2440","city": "Rosario","province": "Santa Fe"},
          {"name": "Servicio de Nefrologia Hospital Italiano","address": "Virasoro 1249","city": "Rosario","province": "Santa Fe"},
          {"name": "Centro Integral de Dialisis VGG","address": "Juan B. Justo 2053","city": "Villa Gobernador Galvez","province": "Santa Fe"},
          {"name": "PLA DIAL SRL","address": "Dorrego 1550","city": "Rosario","province": "Santa Fe"},
          {"name": "Sanatorio MIT","address": "Av. Gdor. Freyre 3074","city": "Santa Fe","province": "Santa Fe"},
          {"name": "Centro de Nefrología y Diálisis Casilda","address": "Buenos Aires 1785","city": "Casilda","province": "Santa Fe"},
          {"name": "Centro de Nefrologia y Dialisis de Rosario SA","address": "Alvear 1179","city": "Rosario","province": "Santa Fe"},
          {"name": "NEFRA Medical Care (Español)","address": "Sarmiento 3150","city": "Rosario","province": "Santa Fe"},
          {"name": "NEFRA Medical Care (Venado Tuerto)","address": "Pellegrini 660","city": "Venado Tuerto","province": "Santa Fe"},
          {"name": "NEFRA Medical Care (San Justo)","address": "Sta. Fe 2983","city": "San Justo","province": "Santa Fe"},
          {"name": "NEFRA Medical Care (Santa Fe)","address": "Mariano Comas 2449","city": "Santa Fe","province": "Santa Fe"},
          {"name": "NEFRA Medical Care (Reconquista)","address": "Mitre 611","city": "Reconquista","province": "Santa Fe"},
          {"name": "NEFRA Medical Care (Rosario 1)","address": "Ocampo 3110","city": "Rosario","province": "Santa Fe"}
        ];

        // --- MATH & GEO LOGIC ---

        // Función sleep para respetar límites de API
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Limpiar dirección de caracteres extraños que confunden a Nominatim (ej: 1º Piso)
        const cleanAddress = (addr) => {
            return addr
                .replace(/\d+º\s*Piso/gi, '')
                .replace(/\d+er\s*Piso/gi, '')
                .replace(/PB/gi, '')
                .replace(/Planta Baja/gi, '')
                .replace(/Dr\./gi, '')
                .replace(/CPN/gi, '')
                .trim();
        };

        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; 
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        };

        // Geocodificar dirección usando Nominatim
        const geocodeAddress = async (address, city, province) => {
            const cleanAddr = cleanAddress(address);
            const query = `${cleanAddr}, ${city}, ${province}, Argentina`;
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
            
            try {
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'RenaxocApp/1.0' } // Buena práctica para Nominatim
                });
                const data = await response.json();
                if (data && data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), found: true };
                }
                return null;
            } catch (error) {
                console.error("Error geocoding:", error);
                return null;
            }
        };

        // --- SERVICES ---

        const fetchCentersFromJson = async () => {
            return EMBEDDED_CENTERS;
        };

        const findNearestCentersLocal = async (formData, setStatus) => {
            const centers = await fetchCentersFromJson();

            // PASO 1: Geolocalizar PACIENTE
            setStatus("Localizando domicilio del paciente...");
            let patientCoords;
            try {
                patientCoords = await geocodeAddress(formData.address, formData.city, formData.province);
                if (!patientCoords) throw new Error("No encontrado");
            } catch (e) {
                // Fallback a ciudad si no encuentra dirección exacta del paciente
                console.warn("Fallo geolocalización exacta paciente, intentando ciudad...");
                const cityKey = formData.city.toLowerCase().trim();
                if(CITY_COORDINATES[cityKey]) {
                     patientCoords = { ...CITY_COORDINATES[cityKey], found: false }; // Found false = es aproximado
                } else {
                    throw new Error("No pudimos ubicar tu dirección ni tu ciudad en el mapa.");
                }
            }

            // PASO 2: Filtrado grueso (Coarse Filter)
            // Calculo distancia aproximada usando coordenadas de CIUDAD para todos los centros
            // Esto es rápido y me permite elegir los "candidatos" a geolocalizar con precisión.
            setStatus("Analizando centros cercanos...");
            
            let coarseResults = centers.map(center => {
                const cityKey = center.city.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
                let centerCoords = CITY_COORDINATES[cityKey];
                if (!centerCoords) centerCoords = CITY_COORDINATES['rosario']; // Fallback seguro

                const dist = calculateDistance(patientCoords.lat, patientCoords.lon, centerCoords.lat, centerCoords.lon);
                return { center, dist, coarse: true };
            });

            // Ordeno y tomo los top 6 candidatos
            coarseResults.sort((a, b) => a.dist - b.dist);
            const topCandidates = coarseResults.slice(0, 6);

            // PASO 3: Geolocalización Fina de Candidatos
            // Ahora busco la lat/lon EXACTA de esos 6 centros
            setStatus("Calculando rutas exactas a los centros...");
            
            const finalResults = [];

            for (let item of topCandidates) {
                // Pequeña pausa para no saturar la API (Rate limit)
                await sleep(400); 

                const c = item.center;
                let exactCoords = await geocodeAddress(c.address, c.city, c.province);
                
                // Si no encuentro la exacta, uso la de la ciudad (fallback)
                if (!exactCoords) {
                    const cityKey = c.city.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
                    exactCoords = CITY_COORDINATES[cityKey] || CITY_COORDINATES['rosario'];
                }

                const exactDist = calculateDistance(patientCoords.lat, patientCoords.lon, exactCoords.lat, exactCoords.lon);
                
                // Url de Maps: Origen Exacto -> Destino Exacto
                // Uso la query de texto para el destino para asegurarme que Maps encuentre la puerta, 
                // pero el cálculo de km en la app ya es preciso gracias al paso anterior.
                const originStr = `${patientCoords.lat},${patientCoords.lon}`;
                const destQuery = `${cleanAddress(c.address)}, ${c.city}, ${c.province}, Argentina`;
                const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${originStr}&destination=${encodeURIComponent(destQuery)}&travelmode=driving`;

                // Estimación tiempo
                const speedKmH = 40; 
                const durationHours = exactDist / speedKmH;
                const durationSeconds = Math.floor(durationHours * 3600);

                finalResults.push({
                    center: c,
                    distanceKm: exactDist,
                    durationText: durationHours < 1 
                        ? `${Math.ceil(durationHours * 60)} min` 
                        : `${Math.floor(durationHours)} h ${Math.ceil((durationHours % 1) * 60)} min`,
                    durationValue: durationSeconds,
                    mapsUrl: mapsUrl,
                    isClosest: false
                });
            }

            // Orden final por distancia exacta
            finalResults.sort((a, b) => a.distanceKm - b.distanceKm);
            
            // Tomo el top 3
            const top3 = finalResults.slice(0, 3);
            if (top3.length > 0) top3[0].isClosest = true;

            saveToLocalHistory(formData, top3);
            return top3;
        };

        const saveToLocalHistory = (formData, results) => {
            const record = {
                date: new Date().toISOString(),
                userName: formData.userName,
                patientName: formData.patientName,
                address: formData.address,
                city: formData.city,
                province: formData.province,
                result: results.length > 0 ? results[0].center.name : "Sin resultados"
            };

            const currentHistory = JSON.parse(localStorage.getItem('renaxoc_history') || '[]');
            currentHistory.unshift(record);
            localStorage.setItem('renaxoc_history', JSON.stringify(currentHistory));
        };

        const getLocalHistory = () => {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const history = JSON.parse(localStorage.getItem('renaxoc_history') || '[]');
                    resolve(history);
                }, 500);
            });
        };

        // --- COMPONENTS ---

        const InputGroup = ({ label, name, value, onChange, placeholder, required }) => (
            <div className="flex flex-col space-y-1">
                <label htmlFor={name} className="text-sm font-medium text-slate-400 ml-1">
                    {label} {required && <span className="text-red-400">*</span>}
                </label>
                <input
                    type="text" id={name} name={name} value={value} onChange={onChange} placeholder={placeholder} required={required}
                    className="bg-slate-800 border border-slate-700 text-slate-100 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder-slate-600"
                />
            </div>
        );

        const ResultCard = ({ result, rank }) => {
            const isWinner = rank === 1;
            
            return (
                <div className={`relative rounded-xl p-5 transition-all duration-300 border ${isWinner ? 'bg-gradient-to-br from-blue-900/40 to-slate-800 border-blue-500 shadow-lg scale-[1.02] z-10' : 'bg-slate-800 border-slate-700'}`}>
                    {isWinner && <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md uppercase">Más Cercano</div>}
                    <div className="flex justify-between items-start mb-3">
                        <div>
                            <h3 className={`font-bold text-lg ${isWinner ? 'text-white' : 'text-slate-200'}`}>{result.center.name}</h3>
                            <p className="text-sm text-slate-400 mt-1">{result.center.address}</p>
                            <p className="text-xs text-slate-500">{result.center.city}, {result.center.province}</p>
                        </div>
                        <div className={`flex items-center justify-center w-8 h-8 rounded-full font-bold ${isWinner ? 'bg-blue-500 text-white' : 'bg-slate-700 text-slate-400'}`}>{rank}</div>
                    </div>
                    <div className="grid grid-cols-2 gap-4 my-4">
                        <div className="bg-slate-900/50 rounded-lg p-3 text-center">
                            <span className="block text-xs text-slate-500 uppercase">Distancia Exacta</span>
                            <span className="text-xl font-mono text-blue-300">{result.distanceKm.toFixed(1)} km</span>
                        </div>
                        <div className="bg-slate-900/50 rounded-lg p-3 text-center">
                            <span className="block text-xs text-slate-500 uppercase">Tiempo Est.</span>
                            <span className="text-sm font-mono text-emerald-300 font-medium">{result.durationText}</span>
                        </div>
                    </div>
                    <a href={result.mapsUrl} target="_blank" rel="noopener noreferrer" className={`flex items-center justify-center w-full py-3 rounded-lg font-semibold transition-colors ${isWinner ? 'bg-blue-600 hover:bg-blue-500 text-white' : 'bg-slate-700 hover:bg-slate-600 text-slate-200'}`}>
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                            <path strokeLinecap="round" strokeLinejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path strokeLinecap="round" strokeLinejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Ver recorrido
                    </a>
                </div>
            );
        };

        const Logo = () => (
            <div className="w-12 h-12 md:w-16 md:h-16 flex-shrink-0 overflow-hidden">
                <img src={LOGO_URL} alt="RENAXOC Logo" className="w-full h-full object-contain" />
            </div>
        );

        const Header = ({ isAdmin, currentView, onToggleView }) => {
            const getButtonClass = (viewName) => {
                const isActive = currentView === viewName;
                return `px-3 md:px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                    isActive ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800'
                }`;
            };

            return (
                <header className="w-full bg-[#1e293b] border-b border-slate-700 shadow-md sticky top-0 z-50">
                    <div className="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center justify-between gap-4">
                        <div className="flex items-center space-x-4 cursor-pointer" onClick={() => onToggleView('search')}>
                            <Logo />
                            <div className="flex flex-col">
                                <h1 className="text-xl md:text-2xl font-bold bg-clip-text white">RENAXOC</h1>
                                <span className="text-xs text-white-300/80 font-light tracking-widest">CENTRO MÁS CERCANO</span>
                            </div>
                        </div>
                        <div className="flex flex-wrap items-center space-x-1 md:space-x-2">
                            <button onClick={() => onToggleView('search')} className={getButtonClass('search')}>Buscador</button>
                            <button onClick={() => onToggleView('centers')} className={getButtonClass('centers')}>Centros</button>
                            {isAdmin && <button onClick={() => onToggleView('history')} className={getButtonClass('history')}>Histórico</button>}
                        </div>
                    </div>
                </header>
            );
        };

        const Footer = () => (
            <footer className="w-full py-6 mt-auto border-t border-slate-700 bg-[#1e293b]">
                <div className="max-w-7xl mx-auto flex flex-row items-center justify-center space-x-3">
                    <h3 className="text-slate-400 font-medium text-sm uppercase tracking-wide">CP Pablo Nicolás Demartis</h3>
                    <a href="https://wa.me/3416177623" target="_blank" rel="noopener noreferrer" className="text-[#25D366] hover:text-[#1da851] transition-colors transform hover:scale-110">
                        <svg className="w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                    </a>
                </div>
            </footer>
        );

        const CentersView = () => {
            const [centers, setCenters] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                fetchCentersFromJson()
                    .then(data => setCenters(data))
                    .catch(e => setError(e.toString()))
                    .finally(() => setLoading(false));
            }, []);

            if (loading) return <div className="text-center p-10 text-slate-400">Cargando centros...</div>;
            if (error) return <div className="text-center p-10 text-red-400">{error}</div>;

            return (
                <div className="w-full max-w-6xl mx-auto animate-fade-in-up pb-10">
                    <h2 className="text-2xl font-bold text-white mb-6 pl-2 border-l-4 border-blue-500">Centros de Diálisis</h2>
                    <div className="overflow-x-auto bg-[#1e293b] rounded-xl shadow-xl border border-slate-700">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="bg-slate-900/50 text-slate-400 text-sm uppercase">
                                    <th className="p-4 border-b border-slate-700">Nombre</th>
                                    <th className="p-4 border-b border-slate-700">Domicilio</th>
                                    <th className="p-4 border-b border-slate-700">Localidad</th>
                                    <th className="p-4 border-b border-slate-700">Provincia</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {centers.map((c, i) => (
                                    <tr key={i} className="hover:bg-slate-800/50">
                                        <td className="p-4 text-blue-300">{c.name}</td>
                                        <td className="p-4 text-slate-200">{c.address}</td>
                                        <td className="p-4 text-slate-400 text-sm">{c.city}</td>
                                        <td className="p-4 text-slate-400 text-sm">{c.province}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const HistoryView = () => {
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                getLocalHistory().then(data => {
                    setHistory(data);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center p-10 text-slate-400">Cargando historial de consultas...</div>;

            return (
                <div className="w-full max-w-6xl mx-auto animate-fade-in-up pb-10">
                    <h2 className="text-2xl font-bold text-white mb-6 pl-2 border-l-4 border-blue-500">Histórico de consultas</h2>
                    <div className="overflow-x-auto bg-[#1e293b] rounded-xl shadow-xl border border-slate-700">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="bg-slate-900/50 text-slate-400 text-sm uppercase">
                                    <th className="p-4 border-b border-slate-700">Fecha</th>
                                    <th className="p-4 border-b border-slate-700">Usuario</th>
                                    <th className="p-4 border-b border-slate-700">Paciente</th>
                                    <th className="p-4 border-b border-slate-700">Resultado</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {history.length === 0 ? (
                                     <tr><td colSpan="4" className="p-6 text-center text-slate-500">No hay consultas recientes en este dispositivo.</td></tr>
                                ) : (
                                    history.map((r, i) => (
                                        <tr key={i} className="hover:bg-slate-800/50">
                                            <td className="p-4 text-slate-300 text-sm">{new Date(r.date).toLocaleDateString()} {new Date(r.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                                            <td className="p-4 text-blue-300">{r.userName}</td>
                                            <td className="p-4 text-slate-200">{r.patientName}</td>
                                            <td className="p-4 text-emerald-400 font-semibold">{r.result}</td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [formData, setFormData] = useState({ userName: '', patientName: '', address: '', city: '', province: '' });
            const [results, setResults] = useState(null);
            const [loading, setLoading] = useState(false);
            const [statusMsg, setStatusMsg] = useState("");
            const [error, setError] = useState(null);
            const [currentView, setCurrentView] = useState('search');
            const [isAdmin, setIsAdmin] = useState(false);

            useEffect(() => {
                setIsAdmin(formData.userName.trim().toLowerCase() === ADMIN_USER);
            }, [formData.userName]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true); 
                setResults(null); 
                setError(null);
                setStatusMsg("Inicializando...");
                
                try {
                    // Se pasa setStatusMsg para dar feedback al usuario del progreso
                    const data = await findNearestCentersLocal(formData, setStatusMsg);
                    setResults(data);
                } catch (err) { setError(err.toString()); }
                finally { setLoading(false); setStatusMsg(""); }
            };

            const handleReset = () => {
                setResults(null);
                setFormData(prev => ({ ...prev, patientName: '', address: '', city: '', province: '' }));
            };

            return (
                <div className="min-h-screen bg-[#0f172a] text-slate-200 flex flex-col">
                    <Header isAdmin={isAdmin} currentView={currentView} onToggleView={setCurrentView} />
                    <main className="flex-grow w-full px-4 py-8">
                        {currentView === 'history' && <HistoryView />}
                        {currentView === 'centers' && <CentersView />}
                        {currentView === 'search' && (
                            <div className="max-w-2xl mx-auto">
                                {!results && (
                                    <div className="bg-[#1e293b]/80 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-6 md:p-8 shadow-xl">
                                        <h2 className="text-xl font-semibold mb-6 text-blue-100 border-b border-slate-700 pb-2">Consulta</h2>
                                        <form onSubmit={handleSubmit} className="space-y-5">
                                            <InputGroup label="Tu Nombre" name="userName" value={formData.userName} onChange={(e) => setFormData({...formData, userName: e.target.value})} placeholder="Ingresa tu nombre" required />
                                            <div className="pt-4 border-t border-slate-700/50">
                                                <p className="text-xs text-blue-400 uppercase font-bold mb-4">Datos del Paciente</p>
                                                <InputGroup label="Nombre y Apellido del Paciente" name="patientName" value={formData.patientName} onChange={(e) => setFormData({...formData, patientName: e.target.value})} placeholder="Ej. Nico Dema" required />
                                                <div className="mt-4"><InputGroup label="Domicilio (Calle y Altura)" name="address" value={formData.address} onChange={(e) => setFormData({...formData, address: e.target.value})} placeholder="Ej. Montevideo 2420" required /></div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                                    <InputGroup label="Localidad" name="city" value={formData.city} onChange={(e) => setFormData({...formData, city: e.target.value})} placeholder="Ej. Roldán" required />
                                                    <InputGroup label="Provincia" name="province" value={formData.province} onChange={(e) => setFormData({...formData, province: e.target.value})} placeholder="Ej. Santa Fe" required />
                                                </div>
                                            </div>
                                            <div className="pt-4">
                                                <button type="submit" disabled={loading} className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all ${loading ? 'bg-slate-700' : 'bg-gradient-to-r from-blue-700 to-blue-600 hover:from-blue-600'}`}>
                                                    {loading ? (statusMsg || "Analizando...") : "BUSCAR CENTROS CERCANOS"}
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                )}
                                {error && <div className="mt-6 p-4 bg-red-900/30 border border-red-800 rounded-lg text-red-200 text-center">{error}</div>}
                                {results && (
                                    <div className="animate-fade-in-up">
                                        <div className="flex justify-between items-center mb-6 mt-2">
                                            <h2 className="text-xl font-bold text-white">Resultados</h2>
                                            <button onClick={handleReset} className="text-sm text-blue-400 hover:text-blue-300 underline">Nueva consulta</button>
                                        </div>
                                        <div className="space-y-6">
                                            {results.map((res, i) => <ResultCard key={i} result={res} rank={i + 1} />)}
                                        </div>
                                        <div className="mt-8 text-center">
                                            <p className="text-slate-500 text-sm">
                                                Resultados basados en geolocalización exacta de domicilios. <br/>
                                                El proceso puede tardar unos segundos para garantizar precisión.
                                            </p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                    <Footer />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
